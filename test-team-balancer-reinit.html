<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Balancer Reinit Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h1>Team Balancer Reinitialization Test</h1>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs mb-4" id="testTabs">
            <li class="nav-item">
                <a class="nav-link active" id="team-balancer-tab" href="#team-balancer">Team Balancer</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="other-tab" href="#other">Other Tab</a>
            </li>
        </ul>
        
        <!-- Content Area -->
        <div id="main-content">
            <!-- Team Balancer content will be loaded here -->
        </div>
        
        <!-- Test Controls -->
        <div class="mt-4">
            <button class="btn btn-primary" onclick="testReinit()">Test Reinitialization</button>
            <button class="btn btn-secondary" onclick="switchToOther()">Switch to Other Tab</button>
            <button class="btn btn-info" onclick="switchToTeamBalancer()">Switch to Team Balancer</button>
        </div>
        
        <div class="mt-3">
            <div id="test-results" class="alert alert-info" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Mock the navigation system
        window.adminApp = {
            loadAndInitModule: async function({ htmlFile, jsFile, contentContainer, initFunction, cleanupFunction }) {
                console.log(`Loading module: ${htmlFile}, init: ${initFunction}, cleanup: ${cleanupFunction}`);
                
                const container = document.getElementById(contentContainer);
                
                // Call cleanup for previous module if it exists
                if (window.activeModule && window.activeModule.cleanup) {
                    console.log('Calling cleanup for previous module');
                    window.activeModule.cleanup();
                }
                
                // Load HTML content
                try {
                    const response = await fetch(htmlFile);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${htmlFile}: ${response.statusText}`);
                    }
                    container.innerHTML = await response.text();
                    
                    // Load JS module
                    if (jsFile) {
                        await loadJavaScriptModule(jsFile);
                    }
                    
                    // Initialize the new module
                    if (typeof window[initFunction] === 'function') {
                        console.log(`Calling init function: ${initFunction}`);
                        await window[initFunction]();
                    } else {
                        console.warn(`Initialization function ${initFunction} not found.`);
                    }
                    
                    // Set the active module for cleanup later
                    window.activeModule = {
                        name: initFunction,
                        cleanup: typeof window[cleanupFunction] === 'function' ? window[cleanupFunction] : null
                    };
                    
                    return true;
                } catch (error) {
                    console.error(`Error loading module ${htmlFile}:`, error);
                    container.innerHTML = `<div class="alert alert-danger">Failed to load content: ${error.message}</div>`;
                    return false;
                }
            }
        };
        
        function loadJavaScriptModule(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.body.appendChild(script);
            });
        }
        
        function testReinit() {
            const results = document.getElementById('test-results');
            results.style.display = 'block';
            results.innerHTML = '<strong>Testing reinitialization...</strong><br>';
            
            // Test switching to team balancer multiple times
            let testCount = 0;
            const maxTests = 3;
            
            function runTest() {
                testCount++;
                results.innerHTML += `Test ${testCount}: Switching to team balancer...<br>`;
                
                switchToTeamBalancer().then(() => {
                    results.innerHTML += `Test ${testCount}: Success!<br>`;
                    
                    if (testCount < maxTests) {
                        setTimeout(() => {
                            switchToOther().then(() => {
                                setTimeout(runTest, 500);
                            });
                        }, 500);
                    } else {
                        results.innerHTML += '<strong>All tests completed successfully! Team balancer reinitializes properly.</strong>';
                        results.className = 'alert alert-success';
                    }
                }).catch(error => {
                    results.innerHTML += `Test ${testCount}: Failed - ${error.message}<br>`;
                    results.className = 'alert alert-danger';
                });
            }
            
            runTest();
        }
        
        async function switchToTeamBalancer() {
            return await window.adminApp.loadAndInitModule({
                htmlFile: 'admin/team-balancer.html',
                jsFile: 'admin/js/teamBalancer.js',
                contentContainer: 'main-content',
                initFunction: 'initTeamBalancer',
                cleanupFunction: 'cleanupTeamBalancer'
            });
        }
        
        async function switchToOther() {
            const container = document.getElementById('main-content');
            container.innerHTML = '<div class="alert alert-info">Other tab content loaded</div>';
            
            // Call cleanup for previous module if it exists
            if (window.activeModule && window.activeModule.cleanup) {
                window.activeModule.cleanup();
            }
            
            window.activeModule = {
                name: 'other',
                cleanup: null
            };
            
            return true;
        }
        
        // Set up tab switching
        document.getElementById('team-balancer-tab').addEventListener('click', async function(e) {
            e.preventDefault();
            await switchToTeamBalancer();
            
            // Update active tab
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
        });
        
        document.getElementById('other-tab').addEventListener('click', async function(e) {
            e.preventDefault();
            await switchToOther();
            
            // Update active tab
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
        });
        
        // Auto-load team balancer on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(switchToTeamBalancer, 100);
        });
    </script>
</body>
</html> 