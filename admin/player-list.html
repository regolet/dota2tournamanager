<!-- player-list.html -->
<section id="player-list" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">
            <i class="bi bi-people-fill me-2"></i>Player List Management
        </h2>
        <div class="btn-group">
            <button type="button" class="btn btn-primary me-2" id="add-player-button">
                <i class="bi bi-person-plus-fill me-1"></i> Add Player
            </button>
            <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#playerListHelpModal">
                <i class="bi bi-question-circle me-1"></i> Help
            </button>
        </div>
    </div>

    <!-- Player List Controls -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-3">
            <div class="row g-3 align-items-center">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="player-search" 
                               placeholder="Search players by name or Dota 2 ID...">
                        <button id="search-button" class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-md-end">
                    <div class="btn-group">
                        <button id="refresh-player-list" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh List
                        </button>
                        <button type="button" class="btn btn-outline-danger me-2" id="remove-all-players-button">
                            <i class="bi bi-trash me-1"></i> Remove All Players
                        </button>
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-download me-1"></i> Export
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="export-csv">CSV</a></li>
                            <li><a class="dropdown-item" href="#" id="export-json">JSON</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="export-print">Print List</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Player List Table -->
    <div class="card shadow-sm border-0 mx-4">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="ps-3">Player</th>
                            <th class="text-center">MMR</th>
                            <th>Dota 2 ID</th>
                            <th>IP Address</th>
                            <th>ID</th>
                            <th>Registered</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="player-table-body" class="border-top-0">
                        <!-- Empty state -->
                        <tr id="no-players-message">
                            <td colspan="7" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="bi bi-people display-6 d-block mb-3 opacity-25"></i>
                                    <h5>No players found</h5>
                                    <p class="mb-0">Add players or check back later</p>
                                </div>
                            </td>
                        </tr>
                        <!-- Player rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <!-- Table Footer -->
            <div class="card-footer bg-light d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    <span id="player-count">0</span> players found
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>10 per page</option>
                        <option>25 per page</option>
                        <option>50 per page</option>
                        <option>100 per page</option>
                    </select>
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bulk Actions Bar removed -->
    
    <!-- Player List Help Modal -->
    <div class="modal fade" id="playerListHelpModal" tabindex="-1" aria-labelledby="playerListHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="playerListHelpModalLabel">
                        <i class="bi bi-question-circle-fill text-primary me-2"></i>Player List Help
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6 class="fw-bold">Managing the Player List:</h6>
                    <ol class="mb-4">
                        <li class="mb-2">Use the search bar to filter players by name or ID</li>
                        <li class="mb-2">Click on column headers to sort the list</li>
                        <li class="mb-2">Edit individual players by clicking the edit button in the Actions column</li>
                        <li>Export the list in various formats using the Export button</li>
                    </ol>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Got it!</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Player Modal -->
    <div class="modal fade" id="add-player-modal" tabindex="-1" aria-labelledby="addPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addPlayerModalLabel">
                        <i class="bi bi-person-plus-fill text-primary me-2"></i>Add New Player
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-player-form">
                        <div class="mb-3">
                            <label for="add-player-name" class="form-label">Player Name</label>
                            <input type="text" class="form-control" id="add-player-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-player-dota2id" class="form-label">Dota 2 ID</label>
                            <input type="text" class="form-control" id="add-player-dota2id" required>
                        </div>
                        <div class="mb-3">
                            <label for="add-player-peakmmr" class="form-label">Peak MMR</label>
                            <input type="number" class="form-control" id="add-player-peakmmr">
                        </div>
                        <div class="mb-3">
                            <label for="add-player-id" class="form-label">Player ID</label>
                            <div class="input-group">
                                <span class="input-group-text">#</span>
                                <input type="text" class="form-control" id="add-player-id" disabled value="Will be auto-generated">
                            </div>
                            <div class="form-text">Player ID is automatically generated upon saving</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-new-player-button">Add Player</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Remove All Players Confirmation Modal -->
    <div class="modal fade" id="remove-all-players-modal" tabindex="-1" aria-labelledby="removeAllPlayersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="removeAllPlayersModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Remove All Players
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>WARNING:</strong> This action cannot be undone!
                    </div>
                    <p>Are you sure you want to remove <strong>all players</strong> from the tournament? This will permanently delete all player records.</p>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="confirm-remove-all-players">
                        <label class="form-check-label" for="confirm-remove-all-players">
                            I understand this action cannot be reversed
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-remove-all-button" disabled>
                        <i class="bi bi-trash-fill me-1"></i>Remove All Players
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Player Modal -->
    <div class="modal fade" id="edit-player-modal" tabindex="-1" aria-labelledby="editPlayerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editPlayerModalLabel">
                        <i class="bi bi-pencil-square text-primary me-2"></i>Edit Player
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-player-form">
                        <input type="hidden" id="edit-player-index">
                        <input type="hidden" id="edit-player-id">
                        <div class="mb-3">
                            <label for="edit-player-name" class="form-label">Player Name</label>
                            <input type="text" class="form-control" id="edit-player-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-player-dota2id" class="form-label">Dota 2 ID</label>
                            <input type="text" class="form-control" id="edit-player-dota2id" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-player-peakmmr" class="form-label">Peak MMR</label>
                            <input type="number" class="form-control" id="edit-player-peakmmr">
                        </div>
                        <div class="mb-3">
                            <label for="edit-player-registration-date" class="form-label">Registration Date</label>
                            <input type="text" class="form-control" id="edit-player-registration-date" readonly>
                            <div class="form-text">Registration date cannot be modified</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-player-changes">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load players
        loadPlayers();
        
        // Set up add player button
        const addPlayerButton = document.getElementById('add-player-button');
        if (addPlayerButton) {
            addPlayerButton.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('add-player-modal'));
                modal.show();
            });
        }
        
        // Set up save new player button
        const saveNewPlayerButton = document.getElementById('save-new-player-button');
        if (saveNewPlayerButton) {
            saveNewPlayerButton.addEventListener('click', function() {
                saveNewPlayer();
            });
        }
        
        // Set up remove all players button
        const removeAllPlayersButton = document.getElementById('remove-all-players-button');
        if (removeAllPlayersButton) {
            removeAllPlayersButton.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('remove-all-players-modal'));
                modal.show();
            });
        }
        
        // Set up confirm checkbox
        const confirmRemoveAllPlayers = document.getElementById('confirm-remove-all-players');
        const confirmRemoveAllButton = document.getElementById('confirm-remove-all-button');
        if (confirmRemoveAllPlayers && confirmRemoveAllButton) {
            confirmRemoveAllPlayers.addEventListener('change', function() {
                confirmRemoveAllButton.disabled = !this.checked;
            });
        }
        
        // Set up confirm remove all button
        if (confirmRemoveAllButton) {
            confirmRemoveAllButton.addEventListener('click', function() {
                removeAllPlayers();
            });
        }
        
        // Set up refresh button
        const refreshButton = document.getElementById('refresh-player-list');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                loadPlayers();
            });
        }
        
        // Set up search
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('player-search');
        if (searchButton && searchInput) {
            searchButton.addEventListener('click', function() {
                filterPlayers(searchInput.value);
            });
            
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    filterPlayers(searchInput.value);
                }
            });
        }
    });
    
    // Load players from API
    async function loadPlayers() {
        const tableBody = document.getElementById('player-table-body');
        const playerCount = document.getElementById('player-count');
        const noPlayersMessage = document.getElementById('no-players-message');
        
        if (!tableBody) return;
        
        try {
            // Show loading state
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading players...</p>
                    </td>
                </tr>
            `;
            
            // Fetch players
            const response = await fetch('/api/players');
            if (!response.ok) {
                throw new Error(`Failed to load players: ${response.status}`);
            }
            
            const players = await response.json();
            
            // Update player count
            if (playerCount) {
                playerCount.textContent = players.length;
            }
            
            // Check if there are players
            if (!players || players.length === 0) {
                if (noPlayersMessage) {
                    tableBody.innerHTML = '';
                    noPlayersMessage.style.display = 'table-row';
                } else {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="bi bi-people display-6 d-block mb-3 opacity-25"></i>
                                    <h5>No players found</h5>
                                    <p class="mb-0">Add players or check back later</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                return;
            }
            
            // Hide no players message
            if (noPlayersMessage) {
                noPlayersMessage.style.display = 'none';
            }
            
            // Render players
            let html = '';
            players.forEach((player, index) => {
                const registrationDate = new Date(player.registrationDate).toLocaleDateString();
                
                html += `
                    <tr>
                        <td class="ps-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm bg-primary-subtle text-primary rounded-circle me-2">
                                    ${player.name.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="fw-medium">${player.name}</div>
                                </div>
                            </div>
                        </td>
                        <td class="text-center"><span class="badge bg-primary">${player.peakmmr}</span></td>
                        <td>${player.dota2id}</td>
                        <td><small class="text-muted">${player.ipAddress || 'N/A'}</small></td>
                        <td><small class="text-muted">${player.id || 'N/A'}</small></td>
                        <td><small class="text-muted">${registrationDate}</small></td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-primary edit-player" data-id="${player.id}" data-index="${index}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger delete-player" data-id="${player.id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            
            // Set up edit buttons
            document.querySelectorAll('.edit-player').forEach(button => {
                button.addEventListener('click', function() {
                    const playerId = this.getAttribute('data-id');
                    const playerIndex = this.getAttribute('data-index');
                    editPlayer(playerId, playerIndex, players);
                });
            });
            
            // Set up delete buttons
            document.querySelectorAll('.delete-player').forEach(button => {
                button.addEventListener('click', function() {
                    const playerId = this.getAttribute('data-id');
                    deletePlayer(playerId);
                });
            });
        } catch (error) {
            console.error('Error loading players:', error);
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="alert alert-danger mb-0">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            Failed to load players: ${error.message}
                        </div>
                    </td>
                </tr>
            `;
        }
    }
    
    // Filter players
    function filterPlayers(query) {
        const rows = document.querySelectorAll('#player-table-body tr:not(#no-players-message)');
        const playerCount = document.getElementById('player-count');
        let visibleCount = 0;
        
        if (!query) {
            rows.forEach(row => {
                row.style.display = '';
                visibleCount++;
            });
        } else {
            const lowerQuery = query.toLowerCase();
            
            rows.forEach(row => {
                const name = row.querySelector('td:nth-child(1)').textContent.toLowerCase();
                const dota2id = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                
                if (name.includes(lowerQuery) || dota2id.includes(lowerQuery)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        if (playerCount) {
            playerCount.textContent = visibleCount;
        }
    }
    
    // Save new player
    async function saveNewPlayer() {
        const nameInput = document.getElementById('add-player-name');
        const dota2idInput = document.getElementById('add-player-dota2id');
        const peakmmrInput = document.getElementById('add-player-peakmmr');
        
        if (!nameInput || !dota2idInput) return;
        
        // Validate inputs
        if (!nameInput.value || !dota2idInput.value) {
            alert('Please fill in all required fields');
            return;
        }
        
        try {
            // Create player object
            const player = {
                name: nameInput.value,
                dota2id: dota2idInput.value,
                peakmmr: parseInt(peakmmrInput.value) || 0,
                registrationDate: new Date().toISOString()
            };
            
            // Save player
            const response = await fetch('/admin/save-players', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Id': localStorage.getItem('adminSessionId')
                },
                body: JSON.stringify({
                    action: 'add',
                    player: player
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save player: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || 'Failed to save player');
            }
            
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('add-player-modal')).hide();
            
            // Reset form
            document.getElementById('add-player-form').reset();
            
            // Reload players
            loadPlayers();
            
        } catch (error) {
            console.error('Error saving player:', error);
            alert(`Failed to save player: ${error.message}`);
        }
    }
    
    // Edit player
    function editPlayer(playerId, playerIndex, players) {
        const player = players.find(p => p.id === playerId);
        
        if (!player) {
            alert('Player not found');
            return;
        }
        
        // Fill form
        document.getElementById('edit-player-index').value = playerIndex;
        document.getElementById('edit-player-id').value = player.id;
        document.getElementById('edit-player-name').value = player.name;
        document.getElementById('edit-player-dota2id').value = player.dota2id;
        document.getElementById('edit-player-peakmmr').value = player.peakmmr;
        
        // Set registration date
        const registrationDate = player.registrationDate ? 
            new Date(player.registrationDate).toLocaleDateString() : 'N/A';
        document.getElementById('edit-player-registration-date').value = registrationDate;
        
        // Set up save button
        const saveButton = document.getElementById('save-player-changes');
        if (saveButton) {
            saveButton.onclick = function() {
                savePlayerChanges(player.id);
            };
        }
        
        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('edit-player-modal'));
        modal.show();
    }
    
    // Save player changes
    async function savePlayerChanges(playerId) {
        const nameInput = document.getElementById('edit-player-name');
        const dota2idInput = document.getElementById('edit-player-dota2id');
        const peakmmrInput = document.getElementById('edit-player-peakmmr');
        
        if (!nameInput || !dota2idInput) return;
        
        // Validate inputs
        if (!nameInput.value || !dota2idInput.value) {
            alert('Please fill in all required fields');
            return;
        }
        
        try {
            // Create player object
            const player = {
                id: playerId,
                name: nameInput.value,
                dota2id: dota2idInput.value,
                peakmmr: parseInt(peakmmrInput.value) || 0
            };
            
            // Save player
            const response = await fetch('/admin/save-players', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Id': localStorage.getItem('adminSessionId')
                },
                body: JSON.stringify({
                    action: 'edit',
                    player: player
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to save player: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || 'Failed to save player');
            }
            
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('edit-player-modal')).hide();
            
            // Reload players
            loadPlayers();
            
        } catch (error) {
            console.error('Error saving player:', error);
            alert(`Failed to save player: ${error.message}`);
        }
    }
    
    // Delete player
    async function deletePlayer(playerId) {
        if (!confirm('Are you sure you want to delete this player?')) {
            return;
        }
        
        try {
            // Delete player
            const response = await fetch('/admin/save-players', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Id': localStorage.getItem('adminSessionId')
                },
                body: JSON.stringify({
                    action: 'delete',
                    playerId: playerId
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to delete player: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || 'Failed to delete player');
            }
            
            // Reload players
            loadPlayers();
            
        } catch (error) {
            console.error('Error deleting player:', error);
            alert(`Failed to delete player: ${error.message}`);
        }
    }
    
    // Remove all players
    async function removeAllPlayers() {
        try {
            // Delete all players
            const response = await fetch('/admin/save-players', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-Id': localStorage.getItem('adminSessionId')
                },
                body: JSON.stringify({
                    action: 'removeAll'
                })
            });
            
            if (!response.ok) {
                throw new Error(`Failed to remove all players: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.message || 'Failed to remove all players');
            }
            
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('remove-all-players-modal')).hide();
            
            // Reset checkbox
            document.getElementById('confirm-remove-all-players').checked = false;
            document.getElementById('confirm-remove-all-button').disabled = true;
            
            // Reload players
            loadPlayers();
            
        } catch (error) {
            console.error('Error removing all players:', error);
            alert(`Failed to remove all players: ${error.message}`);
        }
    }
</script>
